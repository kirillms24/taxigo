{% extends "base.html" %}

{% block content %}
<h2>Чат поддержки</h2>

<!-- Окно чата -->
<div id="chatBox" style="border:1px solid #ccc; height:400px; overflow:auto; padding:5px; background:#f9f9f9;"></div>

<!-- Поле ввода сообщения -->
<input type="text" id="msgInput" placeholder="Введите сообщение" style="width:80%; padding:5px;">
<button onclick="sendMsg()" style="padding:5px 10px;">Отправить</button>

<script>
// Отправка сообщения пользователя
async function sendMsg(){
    let input = document.getElementById('msgInput');
    let msg = input.value.trim();
    if(!msg) return;

    let chatBox = document.getElementById('chatBox');
    chatBox.innerHTML += '<p><b>Вы:</b> ' + msg + '</p>';

    try {
        const res = await fetch("/send_message", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({message: msg})
        });
        const data = await res.json();
        chatBox.innerHTML += '<p><b>Бот:</b> ' + data.response + '</p>';
    } catch (error) {
        chatBox.innerHTML += '<p><b>Бот:</b> Ошибка сервера, попробуйте позже.</p>';
        console.error("Ошибка при отправке сообщения:", error);
    }

    input.value = '';
    chatBox.scrollTop = chatBox.scrollHeight;
}

// Функция для автоматического получения новых сообщений от оператора
async function fetchOperatorMessages(){
    try {
        const res = await fetch("/fetch_operator_messages");
        const data = await res.json();
        let chatBox = document.getElementById('chatBox');

        // Добавляем новые сообщения оператора в чат
        data.messages.forEach(msg => {
            if(!document.getElementById('msg-' + msg.id)){
                chatBox.innerHTML += '<p id="msg-' + msg.id + '"><b>Оператор:</b> ' + msg.content + '</p>';
            }
        });

        chatBox.scrollTop = chatBox.scrollHeight;
    } catch (error) {
        console.error("Ошибка при получении сообщений оператора:", error);
    }
}

// Запуск обновления каждые 3 секунды
setInterval(fetchOperatorMessages, 3000);
</script>
{% endblock %}
