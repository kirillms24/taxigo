{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

<!-- Хедер -->
<div class="header">
    <h1>ТаксиGo</h1>
    <div class="buttons">
        {% if user %}
            <a href="{{ url_for('profile') }}"><button>Личный кабинет</button></a>
            <a href="{{ url_for('support') }}"><button>Поддержка</button></a>
            {% if user.role == 'admin' %}
                <a href="{{ url_for('admin') }}"><button>Админ</button></a>
            {% endif %}
            <a href="{{ url_for('logout') }}"><button>Выйти</button></a>
        {% else %}
            <button onclick="showLoginModal()">Вход / Регистрация</button>
            <a href="{{ url_for('support') }}"><button>Поддержка</button></a>
        {% endif %}
    </div>
</div>

<!-- Основной блок -->
<div class="main-container">
    <div class="call-taxi">
        <h3>Вызвать такси</h3>
        <form id="taxiForm" onsubmit="return callTaxi()">
            <input type="text" id="from" placeholder="Откуда" required>
            <input type="text" id="to" placeholder="Куда" required>
            <button type="submit">Вызвать</button>
        </form>
        <p id="taxiResult" class="taxi-result"></p>
    </div>
    <div id="map" style="flex:1; height:500px;"></div>
</div>

<!-- Модальное окно -->
<div id="loginModal">
    <div class="modal-content">
        <span class="close" onclick="closeLoginModal()">×</span>
        <h3>Вход / Регистрация</h3>
        <form id="loginForm" onsubmit="return loginUser()">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Пароль" required>
            <input type="text" id="name" placeholder="Имя (для регистрации)">
            <button type="submit">Войти / Зарегистрироваться</button>
            <p id="loginMsg" style="color:red; margin-top:10px;"></p>
        </form>
    </div>
</div>

<!-- Скрипты -->
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
ymaps.ready(init);
var map, cars = [];

function init(){
    map = new ymaps.Map("map", {
        center: [55.751244, 37.618423],
        zoom: 12
    });

    // Добавляем 5 машинок
    for(let i=0;i<5;i++){
        let coords = [55.751244 + Math.random()*0.05, 37.618423 + Math.random()*0.05];
        let placemark = new ymaps.Placemark(coords, {}, {
            iconLayout: 'default#image',
            iconImageHref: '/static/images/car.png',
            iconImageSize: [40, 40],
            iconImageOffset: [-20, -20]
        });
        map.geoObjects.add(placemark);
        cars.push(placemark);
    }

    // Движение машинок
    setInterval(()=>{
        cars.forEach(p=>{
            let coords = p.geometry.getCoordinates();
            let newLat = coords[0] + (Math.random()-0.5)*0.001;
            let newLng = coords[1] + (Math.random()-0.5)*0.001;
            p.geometry.setCoordinates([newLat, newLng]);
        });
    },1000);
}

// Вызов такси (псевдо)
function callTaxi(){
    var from = document.getElementById('from').value;
    var to = document.getElementById('to').value;
    document.getElementById('taxiResult').innerText = `Такси направлено от "${from}" к "${to}"`;
    return false;
}

// Модальное окно
function showLoginModal(){ document.getElementById('loginModal').style.display='block'; }
function closeLoginModal(){ document.getElementById('loginModal').style.display='none'; }

// Вход / регистрация
async function loginUser(){
    let email = document.getElementById('email').value;
    let password = document.getElementById('password').value;
    let name = document.getElementById('name').value;
    let msg = document.getElementById('loginMsg');

    try {
        let url = name ? '/register' : '/login';
        let formData = new FormData();
        formData.append('email', email);
        formData.append('password', password);
        if(name) formData.append('name', name);

        let res = await fetch(url, {method:'POST', body:formData});
        if(res.redirected){
            window.location.href = res.url;
        } else {
            let text = await res.text();
            msg.innerText = text;
        }
    } catch(e){
        msg.innerText = "Ошибка сервера, попробуйте позже.";
    }
    return false;
}
</script>
{% endblock %}
