{% extends "base.html" %}

{% block content %}
<div class="header">
    <div class="brand"><h1>–¢–∞–∫—Å–∏Go</h1></div>
    <div class="nav-buttons">
        {% if user %}
            <a href="{{ url_for('profile') }}"><button>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button></a>
            <a href="{{ url_for('support') }}"><button>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button></a>
            {% if user.role=='admin' %}
                <a href="{{ url_for('admin') }}"><button>–ê–¥–º–∏–Ω</button></a>
            {% endif %}
            <a href="{{ url_for('logout') }}"><button>–í—ã–π—Ç–∏</button></a>
        {% else %}
            <button onclick="showLoginModal()">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <a href="{{ url_for('support') }}"><button>–ü–æ–¥–¥–µ—Ä–∂–∫–∞</button></a>
        {% endif %}
    </div>
</div>

<div class="main-container">
    <div class="call-taxi">
        <h3>–í—ã–∑–≤–∞—Ç—å —Ç–∞–∫—Å–∏</h3>
        <form id="taxiForm" onsubmit="return callTaxi()">
            <input type="text" id="from" placeholder="–û—Ç–∫—É–¥–∞" required>
            <input type="text" id="to" placeholder="–ö—É–¥–∞" required>
            <button type="submit">–í—ã–∑–≤–∞—Ç—å</button>
        </form>
        <p id="taxiResult"></p>
    </div>
    <div class="map-card">
        <div id="map"></div>
    </div>
</div>

<div id="loginModal">
    <div class="modal-content">
        <span onclick="closeLoginModal()" style="float:right;cursor:pointer;">√ó</span>
        <h3>–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <form id="loginForm" onsubmit="return loginUser()">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <input type="text" id="name" placeholder="–ò–º—è (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)">
            <button type="submit">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <p id="loginMsg" style="color:red"></p>
        </form>
    </div>
</div>

<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
<script>
    ymaps.ready(init);
    function init() {
        var map = new ymaps.Map('map', {center:[55.751244,37.618423], zoom:12});
        for(let i=0;i<5;i++){
            let car = new ymaps.Placemark(
                [55.751244 + Math.random()*0.05, 37.618423 + Math.random()*0.05],
                {iconContent:'üöï'}
            );
            map.geoObjects.add(car);
        }
    }

    function callTaxi(){
        let from = document.getElementById('from').value;
        let to = document.getElementById('to').value;
        document.getElementById('taxiResult').innerText = `–¢–∞–∫—Å–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç "${from}" –∫ "${to}"`;
        return false;
    }

    function showLoginModal(){ document.getElementById('loginModal').style.display='flex'; }
    function closeLoginModal(){ document.getElementById('loginModal').style.display='none'; }

    async function loginUser(){
        let email=document.getElementById('email').value;
        let password=document.getElementById('password').value;
        let name=document.getElementById('name').value;
        let response;
        if(name){
            response = await fetch('/register',{method:'POST',body:new URLSearchParams({email,password,name})});
        } else {
            response = await fetch('/login',{method:'POST',body:new URLSearchParams({email,password})});
        }
        if(response.redirected){ window.location.href=response.url; }
        else{ document.getElementById('loginMsg').innerText = await response.text(); }
        return false;
    }
</script>
{% endblock %}
